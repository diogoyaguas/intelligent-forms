<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="./css/style-asae.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
</head>

<body>
    <div class="container-contact100">
    </div>
    <div id="i3jcw" class="gjs-row">
        <div id="ii2vh" class="gjs-cell">
        </div>
        <div id="in77" class="gjs-cell">
            <div class="wrap-contact100"><span class="contact100-form-title"><b id="iypi">
                        Queixas e Denúncias</b></span>
                <form method="get" action="submit.html" class="contact100-form validate-form">
                    <div class="w-full dis-none contact-denunciation"><span class="contact100-form-subtitle">Queixoso /
                            Denunciante</span>
                        <div class="wrap-input100 bg1">
                            <span class="label-input100">Nome</span>
                            <input type="Text" name="name" placeholder="Nome" id="ic4cv" class="input100" />
                        </div>
                        <div class="wrap-input100 bg1">
                            <span class="label-input100">Morada</span>
                            <input type="text" name="morada" placeholder="Morada" id="it6rj" class="input100" />
                        </div>
                        <div class="wrap-input100 bg1 rs1-wrap-input100-left">
                            <span class="label-input100">Código-Postal</span>
                            <input type="Text" name="CP" placeholder="Código Postal" inputmode="numeric" id="CP"
                                pattern="\d{4}([ -]\d{3})?" class="input100" />
                        </div>
                        <div class="wrap-input100 bg1 rs1-wrap-input100-right">
                            <span class="label-input100">Localidade</span>
                            <input type="Text" name="localidade" placeholder="Localidade" id="itf0e" class="input100" />
                        </div>
                        <div class="wrap-input100 bg1 rs1-wrap-input100-left">
                            <span class="label-input100">Telefone</span>
                            <input type="Text" name="phone" placeholder="Telefone" maxlength="9" id="ig692"
                                class="input100" />
                        </div>
                        <div class="wrap-input100 bg1 rs1-wrap-input100-right">
                            <span class="label-input100">Email</span>
                            <input type="Email" name="email" placeholder="Email" id="ikrfi" class="input100" />
                        </div>

                        <span class="contact100-form-subtitle">
                            Identificação do Agente Económico visado
                        </span>
                        <div class="wrap-input100 bg1">
                            <span class="label-input100">Nome*</span>
                            <input type="Text" name="name" placeholder="Nome" id="icyd7" class="input100" required />
                        </div>
                        <div class="wrap-input100 bg1">
                            <span class="label-input100">Morada*</span>
                            <input type="text" name="morada" placeholder="Morada" id="imd43" class="input100"
                                required />
                        </div>
                        <div class="wrap-input100 bg1 rs1-wrap-input100-left">
                            <span class="label-input100">Código-Postal</span>
                            <input type="Text" name="CP" placeholder="Código Postal" inputmode="numeric"
                                pattern="\d{4}([ -]\d{3})?" id="i0qr69" class="input100" />
                        </div>
                        <div class="wrap-input100 bg1 rs1-wrap-input100-right" id="iq8gu">
                            <span class="label-input100">Localidade*</span>
                            <input type="Text" name="localidade" placeholder="Localidade" classifier="Default"
                                id="illg3" class="input100" required />
                        </div>
                        <div class="wrap-input100 bg1 rs1-wrap-input100-left">
                            <span class="label-input100">Telefone</span>
                            <input type="Text" name="phone" placeholder="Telefone" maxlength="9" id="itww3d"
                                class="input100" />
                        </div>
                        <div class="wrap-input100 bg1 rs1-wrap-input100-right">
                            <span class="label-input100">Email</span>
                            <input type="Email" name="email" placeholder="Email" id="ith87i" class="input100" />
                        </div>

                        <span class="contact100-form-subtitle">
                            Identificação dos Factos</span>

                        <div class="wrap-input100 bg1">
                            <span class="label-input100">Data*</span>
                            <input type="Date" name="data" placeholder="Data" inputmode="numeric" id="CP-3"
                                pattern="\d{4}([ -]\d{3})?" class="input100" />
                        </div>
                        <div class="label-input100">Descrição*</span>
                            <textarea type="text" name="descrição" placeholder="Descrição" id="text-1" required
                                class="input100" rows="12"></textarea>
                        </div>
                    </div>

                    <div data-tooltip="Irá ser preenchido automaticamente." data-tooltip-length=""
                        data-tooltip-pos="right" id="ipm46i"
                        class="tooltip-component wrap-input100 bg1 rs1-wrap-input100-left">
                        <span class="label-input100">Atividade Económica*</span>
                        <input type="Text" name="atividade_económica" placeholder="Atividade económica" required
                            classifier="Default" id="i4w2ab" class="input100" disabled />
                        <input type="hidden" id="i4w2ab1">
                    </div>
                    <div data-tooltip="Irá ser preenchido automaticamente." data-tooltip-length=""
                        data-tooltip-pos="right" class="tooltip-component wrap-input100 bg1 rs1-wrap-input100-right"
                        id="izpjg">
                        <span class="label-input100">Competência*</span>
                        <input type="Text" name="infração" placeholder="Competência" required classifier="Default"
                            id="iep8x" class="input100" disabled />
                        <input type="hidden" id="iep8x1P">
                    </div>

                    <div class="bg1">
                        <button type="submit" id="i7022" class="submitButton">Enviar</button>
                    </div>
                </form>

                <div class="wrap-input100 bg1 rs1-wrap-input100-left threshold">
                    <span class="label-input100">Threshold of economic activity</span>
                    <input class="input100" type="number" id="threshold-1" value=0.5 min=0 max=1 step=0.01>
                </div>
                <div class="wrap-input100 bg1 rs1-wrap-input100-right threshold">
                    <span class="label-input100">Threshold of competence</span>
                    <input class="input100" type="number" id="threshold-2" value=0.5 min=0 max=1 step=0.01>
                </div>

            </div>
        </div>
        <div id="isiid" class="gjs-cell">
        </div>
    </div>
    <script>
        var props = { "it6rj": { "purpose": "None", "classifier": "Default", "language": "Default", "precision": 0, "submit": "Default", "buttons": "Default", "insert": false }, "imd43": { "purpose": "None", "classifier": "Default", "language": "Default", "precision": 0, "submit": "Default", "buttons": "Default", "insert": false }, "text-1": { "purpose": "Classify", "classifier": "Custom", "language": "Default", "precision": "65", "submit": "Block", "buttons": "i7022", "insert": true } };
        var ids = Object.keys(props).map(function (id) { return '#' + id }).join(',');
        var els = document.querySelectorAll(ids);
        for (var i = 0, len = els.length; i < len; i++) {
            var el = els[i];
            (function (props) {

                function elemental(el) {
                    el.oneEventListener = (event, func, id) => {
                        if (el.lastEventListener == null || el.lastEventListener == 0) {
                            el.lastEventListener = {};
                        }
                        if (el.lastEventListener[id] != null) {
                            el.removeEventListener(event, el.lastEventListener[id]);
                        }
                        el.addEventListener(event, func);
                        el.lastEventListener[id] = func;
                        var temp = document.getElementById("temp");
                        if (!temp) {
                            temp = document.createElement("span");
                            temp.id = "temp";
                            el.parentNode.appendChild(temp);
                        }
                        temp.events = el.lastEventListener;
                    }
                    return el;
                }

                // eventhandler singleton, support querySelector, getElementById, etc, even support querySelectorAll and getElementsByClassName
                function proxy(el) {
                    if (!(el instanceof NodeList)) {
                        return elemental(el);
                    } else {
                        el.forEach(ele => {
                            ele = elemental(ele);
                        });
                        return el;
                    }
                }

                // Collects the selected purpose and classifier.
                var purpose = props.purpose;
                var classifier = props.classifier;

                // Checks whether there is a purpose for applying a model.
                if (purpose == "None") {
                    if (this.nodeName == "TEXTAREA") {
                        if (this.lastEventListener != null && this.lastEventListener[this.id] != null) {
                            this.removeEventListener("blur", this.lastEventListener[this.id])
                            this.lastEventListener[this.id] = null;
                        }
                    } else if (props.component != "Default" && props.component != undefined) {
                        var extractor = proxy(document.getElementById(props.component));
                        if (extractor.lastEventListener != null) {
                            if (extractor.lastEventListener[this.id] != null) {
                                extractor.removeEventListener("blur", extractor.lastEventListener[this.id])
                                extractor.lastEventListener[this.id] = null;
                            }
                        }
                    }
                    return;
                }

                if (!props.insert) return;

                // Checks whether to apply a model to a Textarea.
                if (this.nodeName == "TEXTAREA") {

                    // Collects the selected values.
                    var precision = props.precision / 100;
                    var submit = props.submit;

                    if (submit == "Block" && props.buttons != "Default") { // Block the button selected.
                        document.querySelectorAll("button").forEach(function (button) { button.disabled = false; });
                        document.getElementById(props.buttons).disabled = true;
                    } else if (submit == "Allow") { // Unlock  all buttons available.
                        document.querySelectorAll("button").forEach(function (button) { button.disabled = false; });
                    } else if (submit == "Block" && props.buttons == "Default") return;

                    if (classifier == "Default" || precision == 0) return;
                    if (classifier == "Classifier3" && props.language == "Default") return;

                    switch (classifier) { // Select the classifier.

                        case "Custom":

                            if (this.fields == undefined) {
                                var fields = [];
                                fields.push($('#i4w2ab'));
                                this.fields = fields;
                            }

                            this.addEventListener("blur", function () {
                                $('#i4w2ab')
                                    .replaceWith(this.fields[0]);
                                $('#i4w2ab').val("");
                                if (this.value != "") { // Checks for text to classify.

                                    document.getElementById("i4w2ab").classList.remove("wrong-border");
                                    document.getElementById("i4w2ab").classList.remove("correct-border");
                                    document.getElementById("iep8x").classList.remove("wrong-border");
                                    document.getElementById("iep8x").classList.remove("correct-border");
                                    document.getElementById("i4w2ab").classList.add("alerts-border");
                                    document.getElementById("iep8x").classList.add("alerts-border");

                                    document.getElementById(props.buttons).disabled = true;
                                    document.getElementById(props.buttons).style.backgroundColor = "#696969";
                                    document.getElementById(props.buttons).style.cursor = "auto";

                                    fetch("http://10.227.107.138:8026/classify", {
                                        "method": "POST",
                                        "headers": {
                                            "Access-Control-Allow-Origin": "*",
                                            "Access-Control-Allow-Methods": "POST",
                                            "Access-Control-Allow-Headers": "X-Requested-With, Content-Type",
                                        },
                                        "body": JSON.stringify({ "text": this.value, "model": "/home/tro/server/out/20210616_103813", "task": "economic_class" })
                                    })
                                        .then(response => response.json())
                                        .then(result => {
                                            var thresholdActivity = +document.getElementById('threshold-1').value;
                                            var keys = [];
                                            Object.keys(result).forEach(key => {
                                                if (result[key] >= thresholdActivity) keys.push(key);
                                            });
                                            if (keys.length == 0) {
                                                var key = Object.keys(result).reduce((a, b) => result[a] > result[b] ? a : b);
                                                document.getElementById("i4w2ab").value = key
                                                document.getElementById("i4w2ab1").value = result[key];
                                                document.getElementById("i4w2ab").classList.add("wrong-border");
                                            } else if (keys.length == 1) {
                                                document.getElementById("i4w2ab").classList.add("correct-border");
                                                document.getElementById("i4w2ab").value = keys[0];
                                                document.getElementById("i4w2ab1").value = result[keys[0]];
                                            } else if (keys.length > 1) {
                                                $("#i4w2ab")
                                                    .replaceWith('<select id="i4w2ab" name="economic_activity"></select>');
                                                keys.forEach(key => {
                                                    $("#i4w2ab").append('<option value="' + result[key] + '">' + key + '</option>');
                                                });
                                                var selectList = $('#i4w2ab option');
                                                selectList.sort(function (a, b) {
                                                    a = a.value;
                                                    b = b.value;

                                                    return b - a;
                                                });
                                                $("#i4w2ab").html(selectList);
                                                $("#i4w2ab").val($("#i4w2ab option:first").val());
                                                $("#i4w2ab option:first").attr('selected', 'selected');
                                                document.getElementById("i4w2ab").classList.add("correct-border");
                                            }
                                            document.getElementById("i4w2ab").classList.remove("alerts-border");
                                        })

                                    fetch("http://10.227.107.138:8026/classify", {
                                        "method": "POST",
                                        "headers": {
                                            "Access-Control-Allow-Origin": "*",
                                            "Access-Control-Allow-Methods": "POST",
                                            "Access-Control-Allow-Headers": "X-Requested-With, Content-Type",
                                        },
                                        "body": JSON.stringify({ "text": this.value, "model": "/home/tro/server2/out/20210410_110610", "task": "competence_class" })
                                    })
                                        .then(response => response.json())
                                        .then(result => {
                                            var key = Object.keys(result).reduce((a, b) => result[a] > result[b] ? a : b);
                                            var competence = key;
                                            if (key == "OTHER") {
                                                competence = "Outra entidade"
                                            }
                                            document.getElementById("iep8x").value = competence;
                                            document.getElementById("iep8x1P").value = result[key];
                                            document.getElementById("iep8x").classList.remove("alerts-border");

                                            var thresholdActivity = +document.getElementById('threshold-1').value;
                                            var thresholdCompetence = +document.getElementById('threshold-2').value;

                                            if (document.getElementById("iep8x1P").value < thresholdCompetence || key != "ASAE") {
                                                document.getElementById("iep8x").classList.add("wrong-border");
                                                return;
                                            } else document.getElementById("iep8x").classList.add("correct-border");

                                            if (document.getElementById("i4w2ab1").value >= thresholdActivity && document.getElementById("iep8x1P").value >= thresholdCompetence) {
                                                if (submit == "Block") { // Unlock the button selected.
                                                    document.getElementById(props.buttons).disabled = false;
                                                    document.getElementById(props.buttons).style.backgroundColor = "#228B22";
                                                    document.getElementById(props.buttons).style.cursor = "pointer";
                                                }
                                            }
                                        })
                                }
                            });
                            break;

                    }
                }
            }.bind(el))(props[el.id]);
        }
    </script>
</body>
<html>